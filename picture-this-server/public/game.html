<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game - Picture This</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px 40px;
    }

    .container {
      max-width: none;
      width: 100%;
      padding: 0;
    }

    .loading {
      text-align: center;
      color: white;
      padding: 60px 20px;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .game-screen {
      display: none;
    }

    .game-screen.active {
      display: block;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .round-info {
      font-size: 18px;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    /* Timer styling */
    .timer-section {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 15px 20px;
      color: white;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .timer-label {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .timer-display {
      font-size: 36px;
      font-weight: bold;
      font-family: 'Courier New', monospace;
    }

    .timer-warning {
      color: #ffeb3b;
    }

    .timer-critical {
      color: #ff5252;
      animation: pulse 0.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Main content area */
    .content {
      position: relative;
      display: grid;
      grid-template-columns: 1fr 250px;
      gap: 30px;
      margin-bottom: 30px;
    }

    /* Judge info (right side) */
    .judge-info {
      background: white;
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    .judge-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .judge-avatar {
      font-size: 60px;
      line-height: 1;
      margin: 10px 0;
    }

    .judge-name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      word-wrap: break-word;
      margin: 8px 0;
    }

    /* Sentence template (left side) */
    .sentence-section {
      background: white;
      border-radius: 16px;
      padding: 60px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .sentence-label {
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .sentence-template {
      font-size: 42px;
      font-weight: 600;
      color: #333;
      line-height: 1.6;
      text-align: center;
      word-wrap: break-word;
    }

    .blank {
      background: #667eea;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: bold;
      display: inline-block;
    }

    /* Images section (for display) */
    .images-section {
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 30px;
      display: none;
    }

    .images-section.active {
      display: block;
    }

    .images-grid {
      position: relative;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      overflow: hidden;
    }

    .carousel-container {
      position: relative;
      width: 100%;
      padding-bottom: 75%; /* 4:3 aspect ratio */
      background: #f0f0f0;
      border-radius: 12px;
      overflow: hidden;
    }

    .image-card {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    .image-card.active {
      display: flex;
      opacity: 1;
    }

    .image-card img {
      max-width: 100%;
      max-height: calc(100% - 80px);
      width: auto;
      height: auto;
      object-fit: contain;
      background: #fff;
    }

    .carousel-controls {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      transform: translateY(-50%);
      display: flex;
      justify-content: space-between;
      pointer-events: none;
      z-index: 10;
    }

    .carousel-btn {
      pointer-events: all;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s;
      margin: 0 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .carousel-btn:hover {
      background: white;
      transform: scale(1.1);
    }

    .carousel-indicators {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: all 0.3s;
    }

    .indicator.active {
      background: white;
      width: 24px;
      border-radius: 5px;
    }

    .image-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 15px;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
      color: white;
      text-align: center;
      font-size: 14px;
    }

    .image-sentence {
      font-weight: 600;
      margin-bottom: 4px;
      line-height: 1.4;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .image-style {
      font-size: 12px;
      opacity: 0.9;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .images-loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .images-loading .spinner {
      border: 4px solid rgba(102, 126, 234, 0.2);
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    /* Card hand section - Hidden (not used during game view) */
    .card-hand-section {
      display: none;
    }

    .card-hand-label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .card-hand-placeholder {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 16px;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
      gap: 12px;
    }

    /* Error message */
    .error-message {
      background: #ff5252;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .leave-btn {
      background: #f44336;
      color: white;
      margin-top: 20px;
      width: 100%;
    }

    .leave-btn:hover {
      background: #d32f2f;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .content {
        grid-template-columns: 1fr;
        margin-bottom: 0;
      }

      .judge-info {
        order: -1;
      }

      .sentence-template {
        font-size: 24px;
      }

      .timer-section {
        position: static;
        margin-bottom: 20px;
      }

      .sentence-section {
        padding: 25px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading state -->
    <div class="loading" id="loadingView">
      <div class="spinner"></div>
      <h2 style="margin-bottom: 10px;">Preparing Game...</h2>
      <p style="opacity: 0.8;">Waiting for game to start</p>
    </div>

    <!-- Game screen -->
    <div class="game-screen" id="gameScreen">
      <div class="timer-section">
        <div class="timer-label">Time Remaining</div>
        <div class="timer-display" id="timerDisplay">45</div>
      </div>

      <div class="error-message" id="errorMessage"></div>

      <div class="content">
        <div class="sentence-section">
          <div class="sentence-label">Fill in the blanks</div>
          <div class="sentence-template" id="sentenceTemplate">
            Loading sentence...
          </div>
        </div>

        <div class="judge-info">
          <div class="judge-label">Judge</div>
          <div class="judge-avatar" id="judgeAvatar">üéÆ</div>
          <div class="judge-name" id="judgeName">Loading...</div>
        </div>
      </div>

      <!-- Images section (displayed during IMAGE_GEN and JUDGING phases) -->
      <div class="images-section" id="imagesSection">
        <div class="card-hand-label">Generated Images</div>
        <div class="images-loading" id="imagesLoading" style="display: none;">
          <div class="spinner"></div>
          <p>Generating images...</p>
        </div>
        <div class="images-grid" id="imagesGrid">
          <div class="carousel-container">
            <div class="carousel-controls">
              <button class="carousel-btn" id="prevBtn" onclick="prevImage()">&lt;</button>
              <button class="carousel-btn" id="nextBtn" onclick="nextImage()">&gt;</button>
            </div>
            <div class="carousel-indicators" id="carouselIndicators"></div>
          </div>
        </div>
      </div>

      <div class="card-hand-section">
        <div class="card-hand-label">Your Cards</div>
        <div class="card-hand-placeholder" id="cardHandPlaceholder">
          Waiting for more players or game phase...
        </div>
        <div class="cards-grid" id="cardHand" style="display: none;"></div>
      </div>

      <button class="leave-btn" id="leaveBtn">Leave Game</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Get game code from URL
    const urlParams = new URLSearchParams(window.location.search);
    const gameCode = urlParams.get('code');

    if (!gameCode) {
      document.body.innerHTML = '<div style="color: white; padding: 50px; text-align: center;"><h2>Error: No game code provided</h2></div>';
    }

    let socket = null;
    let gameStarted = false;
    let currentTimer = 45;
    let gameData = null;

    // Connect to WebSocket
    function connectWebSocket() {
      socket = io();

      socket.on('connect', () => {
        console.log('Connected to game server');
        // Small delay to ensure all event listeners are registered before joining room
        setTimeout(() => {
          socket.emit('watch-game', { code: gameCode });
          console.log('Joined game room:', gameCode);
        }, 100);
      });

      // Listen for game-started event BEFORE joining the room
      socket.on('game-started', (payload) => {
        console.log('Game started event received:', payload);
        gameStarted = true;
        stopPolling(); // Stop polling once we get the real-time event
        gameData = payload;

        // Update UI
        const loadingView = document.getElementById('loadingView');
        const gameScreen = document.getElementById('gameScreen');
        
        if (loadingView) loadingView.style.display = 'none';
        if (gameScreen) gameScreen.classList.add('active');

        // Display sentence template with blanks highlighted
        const sentence = payload.sentence || payload.sentenceTemplate || 'I SAW A _____ TRYING TO _____';
        const formattedSentence = sentence.replace(/_____/g, '<span class="blank">BLANK</span>');
        const sentenceEl = document.getElementById('sentenceTemplate');
        if (sentenceEl) sentenceEl.innerHTML = formattedSentence;

        // Display judge info
        const judgeAvatar = document.getElementById('judgeAvatar');
        const judgeName = document.getElementById('judgeName');
        const judgeInfo = document.querySelector('.judge-info');
        if (payload.judge && payload.judge.name) {
          if (judgeInfo) judgeInfo.style.display = '';
          if (judgeAvatar) judgeAvatar.textContent = payload.judge.avatar || 'üéÆ';
          if (judgeName) judgeName.textContent = payload.judge.name;
        } else {
          // Hide judge info if no judge selected
          if (judgeInfo) judgeInfo.style.display = 'none';
        }

        // Start timer
        currentTimer = payload.time_remaining || 45;
        updateTimerDisplay();
      });

      // Listen for timer updates
      socket.on('timer-update', (payload) => {
        currentTimer = payload.time_remaining;
        updateTimerDisplay();
      });

      // Listen for image generation started (batch)
      socket.on('image_generation_started', (data) => {
        console.log('Image generation started:', data);
        showImages(true); // Show images section
        const imagesLoading = document.getElementById('imagesLoading');
        if (imagesLoading) imagesLoading.style.display = 'block';
      });

      // Listen for individual image ready (streaming as they arrive)
      socket.on('image-ready', (data) => {
        console.log('Image ready:', data);
        addImageToDisplay(data);
      });

      // Listen for all images ready (batch, for backward compatibility)
      socket.on('images_ready', (data) => {
        console.log('Images ready:', data);
        showImages(true);
        const imagesLoading = document.getElementById('imagesLoading');
        if (imagesLoading) imagesLoading.style.display = 'none';
        updateImagesDisplay(data.images);
      });

      // Listen for results (winner announcement)
      socket.on('results_ready', (data) => {
        console.log('Results ready:', data);
        showResults(data);
      });

      // Listen for errors
      socket.on('error', (error) => {
        console.error('Socket error:', error);
        showError('Connection error: ' + error);
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from server');
        stopPolling(); // Stop polling if disconnected
      });
    }

    function showImages(show) {
      const imagesSection = document.getElementById('imagesSection');
      if (imagesSection) {
        if (show) {
          imagesSection.classList.add('active');
        } else {
          imagesSection.classList.remove('active');
        }
      }
    }

    function addImageToDisplay(imageData) {
      const carouselContainer = document.querySelector('.carousel-container');
      if (!carouselContainer) return;

      // Show images section if hidden
      showImages(true);

      const imagesLoading = document.getElementById('imagesLoading');
      if (imagesLoading) imagesLoading.style.display = 'none';

      // Check if this is the first image
      const existingCards = carouselContainer.querySelectorAll('.image-card');
      const isFirstImage = existingCards.length === 0;

      // Find existing card for this player, or create new one
      let existingCard = carouselContainer.querySelector(`[data-player-id="${imageData.playerId}"]`);
      
      if (existingCard) {
        // Update existing card
        existingCard.innerHTML = `
          <img src="${imageData.imagePath || imageData.imageUrl || '/generated-images/placeholder.png'}" alt="Generated Image">
          <div class="image-info">
            <div class="image-sentence">${imageData.completedSentence || 'Generated image'}</div>
            <div class="image-style">Style: ${imageData.artStyle || 'N/A'}</div>
          </div>
        `;
      } else {
        // Create new card
        const newCard = document.createElement('div');
        newCard.className = 'image-card';
        newCard.setAttribute('data-player-id', imageData.playerId);
        newCard.innerHTML = `
          <img src="${imageData.imagePath || imageData.imageUrl || '/generated-images/placeholder.png'}" alt="Generated Image">
          <div class="image-info">
            <div class="image-sentence">${imageData.completedSentence || 'Generated image'}</div>
            <div class="image-style">Style: ${imageData.artStyle || 'N/A'}</div>
          </div>
        `;
        carouselContainer.appendChild(newCard);
      }

      // Reset carousel index if this is the first image
      if (isFirstImage) {
        currentImageIndex = 0;
      }

      // Update carousel
      updateCarousel();

      // Log progress
      const totalCards = carouselContainer.querySelectorAll('.image-card').length;
      console.log(`Image ${totalCards} ready: ${imageData.playerId}`);
    }

    function updateImagesDisplay(images) {
      const carouselContainer = document.querySelector('.carousel-container');
      const imagesLoading = document.getElementById('imagesLoading');
      
      if (!carouselContainer) return;

      if (imagesLoading) imagesLoading.style.display = 'none';

      // Convert images object to array if needed
      const imagesArray = Array.isArray(images)
        ? images
        : Object.entries(images).map(([playerId, imgData], index) => ({
            playerId,
            playerNumber: index + 1,
            imageUrl: imgData.imagePath || imgData.imageUrl,
            completedSentence: imgData.completedSentence,
            artStyle: imgData.artStyle,
            generatedAt: imgData.generatedAt,
            isPlaceholder: imgData.isPlaceholder || false
          }));

      // Clear existing images except controls and indicators
      const existingCards = carouselContainer.querySelectorAll('.image-card');
      existingCards.forEach(card => card.remove());

      // Reset carousel index
      currentImageIndex = 0;
      stopCarouselAutoplay();

      // Render image cards
      imagesArray.forEach((img, index) => {
        const card = document.createElement('div');
        card.className = 'image-card';
        card.setAttribute('data-player-id', img.playerId);
        card.innerHTML = `
          <img src="${img.imageUrl || '/generated-images/placeholder.png'}" alt="Player ${img.playerNumber || index + 1}">
          <div class="image-info">
            <div class="image-sentence">${img.completedSentence || 'Generated image'}</div>
            <div class="image-style">Style: ${img.artStyle || 'N/A'}</div>
          </div>
        `;
        carouselContainer.appendChild(card);
      });

      // Initialize carousel
      updateCarousel();
    }

    // Carousel state
    let currentImageIndex = 0;
    let carouselInterval = null;

    function updateCarousel() {
      const carouselContainer = document.querySelector('.carousel-container');
      if (!carouselContainer) return;

      const cards = carouselContainer.querySelectorAll('.image-card');
      const indicators = document.getElementById('carouselIndicators');
      const controls = carouselContainer.querySelector('.carousel-controls');
      
      // Show/hide controls based on number of images
      const hasMultipleImages = cards.length > 1;
      if (controls) {
        controls.style.display = hasMultipleImages ? 'flex' : 'none';
      }
      
      // Update indicators
      if (indicators) {
        if (hasMultipleImages) {
          indicators.innerHTML = Array.from(cards).map((_, index) => 
            `<div class="indicator ${index === currentImageIndex ? 'active' : ''}" onclick="goToImage(${index})"></div>`
          ).join('');
        } else {
          indicators.innerHTML = '';
        }
      }

      // Show current card
      cards.forEach((card, index) => {
        card.classList.toggle('active', index === currentImageIndex);
      });

      // Start autoplay if multiple images
      if (hasMultipleImages) {
        startCarouselAutoplay();
      } else {
        stopCarouselAutoplay();
      }
    }

    function nextImage() {
      const carouselContainer = document.querySelector('.carousel-container');
      if (!carouselContainer) return;
      
      const cards = carouselContainer.querySelectorAll('.image-card');
      if (cards.length === 0) return;
      
      currentImageIndex = (currentImageIndex + 1) % cards.length;
      updateCarousel();
    }

    function prevImage() {
      const carouselContainer = document.querySelector('.carousel-container');
      if (!carouselContainer) return;
      
      const cards = carouselContainer.querySelectorAll('.image-card');
      if (cards.length === 0) return;
      
      currentImageIndex = (currentImageIndex - 1 + cards.length) % cards.length;
      updateCarousel();
    }

    function goToImage(index) {
      currentImageIndex = index;
      updateCarousel();
    }

    function startCarouselAutoplay() {
      // Clear existing interval
      if (carouselInterval) {
        clearInterval(carouselInterval);
      }
      
      // Start new autoplay (change image every 4 seconds)
      carouselInterval = setInterval(() => {
        nextImage();
      }, 4000);
    }

    function stopCarouselAutoplay() {
      if (carouselInterval) {
        clearInterval(carouselInterval);
        carouselInterval = null;
      }
    }

    // Pause autoplay on hover
    document.addEventListener('DOMContentLoaded', () => {
      const carouselContainer = document.querySelector('.carousel-container');
      if (carouselContainer) {
        carouselContainer.addEventListener('mouseenter', stopCarouselAutoplay);
        carouselContainer.addEventListener('mouseleave', () => {
          const cards = carouselContainer.querySelectorAll('.image-card');
          if (cards.length > 1) startCarouselAutoplay();
        });
      }
    });

    function showResults(data) {
      const { results, images, players, isSinglePlayer } = data;
      
      // Stop carousel autoplay
      stopCarouselAutoplay();
      
      if (!results) {
        console.warn('No results data provided');
        return;
      }

      // Get the winner
      const firstPlaceId = results.firstPlace;
      const firstPlacePlayer = players.find(p => p.id === firstPlaceId);
      
      // Display winner announcement
      const gameScreen = document.getElementById('gameScreen');
      if (!gameScreen) return;

      // Create results overlay
      const resultsOverlay = document.createElement('div');
      resultsOverlay.className = 'results-overlay';
      resultsOverlay.id = 'resultsOverlay';
      resultsOverlay.innerHTML = `
        <div class="results-content">
          <h2>Round ${data.round} Complete!</h2>
          ${isSinglePlayer ? `
            <div class="winner-announcement">
              <div class="winner-text">üéâ Winner: ${firstPlacePlayer ? firstPlacePlayer.name : 'Player'} üéâ</div>
              <p>Your image has been selected as the best!</p>
              <div class="winner-score">Points: +3</div>
            </div>
          ` : `
            <div class="winner-announcement">
              <div class="winner-text">üèÜ Winner: ${firstPlacePlayer ? firstPlacePlayer.name : 'Player'} üèÜ</div>
              <p>Your image was selected as the best!</p>
              <div class="winner-score">Points: +3</div>
            </div>
          `}
          <div class="current-standings">
            <h3>Standings</h3>
            <ul>
              ${players.sort((a, b) => b.score - a.score).map((p, idx) => `
                <li>${idx + 1}. ${p.name} - ${p.score} points</li>
              `).join('')}
            </ul>
          </div>
          <p class="next-round-text">Get ready for the next round...</p>
        </div>
      `;

      // Add styles for results overlay
      if (!document.getElementById('resultsStyles')) {
        const style = document.createElement('style');
        style.id = 'resultsStyles';
        style.innerHTML = `
          .results-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease-in;
          }

          @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
          }

          .results-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          }

          .results-content h2 {
            font-size: 32px;
            color: #333;
            margin-bottom: 20px;
          }

          .winner-announcement {
            margin: 20px 0;
          }

          .winner-text {
            font-size: 28px;
            color: #667eea;
            font-weight: 700;
            margin-bottom: 10px;
          }

          .winner-announcement p {
            color: #666;
            margin-bottom: 15px;
          }

          .winner-score {
            font-size: 20px;
            color: #4caf50;
            font-weight: 600;
            background: #f0f9f0;
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
          }

          .current-standings {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
          }

          .current-standings h3 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
          }

          .current-standings ul {
            list-style: none;
            padding: 0;
            margin: 0;
          }

          .current-standings li {
            padding: 8px 0;
            color: #666;
            border-bottom: 1px solid #eee;
          }

          .current-standings li:last-child {
            border-bottom: none;
          }

          .next-round-text {
            color: #999;
            margin-top: 20px;
            font-size: 14px;
          }
        `;
        document.head.appendChild(style);
      }

      gameScreen.appendChild(resultsOverlay);

      // Auto-remove results overlay and prepare for next round after 8 seconds
      setTimeout(() => {
        const overlay = document.getElementById('resultsOverlay');
        if (overlay) {
          overlay.remove();
        }
        // At this point, the server will auto-advance to next round
      }, 8000);
    }

    function updateTimerDisplay() {
      const timerDisplay = document.getElementById('timerDisplay');
      timerDisplay.textContent = currentTimer;

      // Change color based on time remaining
      if (currentTimer <= 5) {
        timerDisplay.className = 'timer-display timer-critical';
      } else if (currentTimer <= 15) {
        timerDisplay.className = 'timer-display timer-warning';
      } else {
        timerDisplay.className = 'timer-display';
      }
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.classList.add('show');
      setTimeout(() => {
        errorEl.classList.remove('show');
      }, 5000);
    }

    // Leave game button
    document.getElementById('leaveBtn').addEventListener('click', () => {
      localStorage.removeItem('gameCode');
      window.location.href = '/player-join.html';
    });

    // Fetch game state via REST API
    async function fetchGameState() {
      try {
        const response = await fetch(`/api/session/${gameCode}`);
        if (!response.ok) {
          throw new Error('Failed to fetch game state');
        }

        const data = await response.json();
        console.log('Fetching game state from:', `/api/session/${gameCode}`);
        console.log('Game session data:', data);

        // Check if game has started
        const gameInProgress = data.status === 'in_progress' || 
                              data.currentPhase === 'round_1_selection' ||
                              (data.currentRound && data.currentRound > 0);

        if (data.sentenceTemplate && gameInProgress) {
          // Game has started, show game content
          if (!gameStarted) {
            gameStarted = true;
            console.log('Game started detected via polling');
            
            // Hide loading, show game screen
            const loadingView = document.getElementById('loadingView');
            const gameScreen = document.getElementById('gameScreen');
            if (loadingView) loadingView.style.display = 'none';
            if (gameScreen) gameScreen.classList.add('active');

            // Display sentence template with blanks highlighted
            const formattedSentence = data.sentenceTemplate.replace(/_____/g, '<span class="blank">BLANK</span>');
            const sentenceEl = document.getElementById('sentenceTemplate');
            if (sentenceEl) sentenceEl.innerHTML = formattedSentence;

            // Display judge info if available
            const judgeAvatarEl = document.getElementById('judgeAvatar');
            const judgeNameEl = document.getElementById('judgeName');
            const judgeInfoEl = document.querySelector('.judge-info');
            if (data.judge && data.judge.name) {
              if (judgeInfoEl) judgeInfoEl.style.display = '';
              if (judgeAvatarEl) judgeAvatarEl.textContent = data.judge.avatar || 'üéÆ';
              if (judgeNameEl) judgeNameEl.textContent = data.judge.name;
            } else if (data.judgeId) {
              // Fallback to judgeId if no judge object
              if (judgeInfoEl) judgeInfoEl.style.display = '';
              if (judgeAvatarEl) judgeAvatarEl.textContent = 'üéÆ';
              if (judgeNameEl) judgeNameEl.textContent = 'Judge ' + data.judgeId.substring(0, 8);
            } else {
              // Hide judge info if no judge assigned
              if (judgeInfoEl) judgeInfoEl.style.display = 'none';
            }
          }
        } else {
          console.log('Game not started yet, waiting for game-started event...');
        }
      } catch (error) {
        console.error('Error fetching game state:', error);
      }
    }

    // Poll game state periodically
    let pollInterval = null;

    function startPolling() {
      // Poll immediately
      fetchGameState();
      // Then poll every 2 seconds
      pollInterval = setInterval(fetchGameState, 2000);
    }

    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }

    // Initialize game
    async function initializeGame() {
      try {
        // Start polling for game state changes
        startPolling();

        // Connect to WebSocket for real-time updates
        connectWebSocket();
      } catch (error) {
        console.error('Error initializing game:', error);
        showError('Failed to load game: ' + error.message);
        setTimeout(() => {
          window.location.href = '/player-join.html';
        }, 3000);
      }
    }

    // Initialize on page load
    window.addEventListener('load', initializeGame);

    // Stop polling when page unloads
    window.addEventListener('beforeunload', stopPolling);
  </script>
</body>
</html>
