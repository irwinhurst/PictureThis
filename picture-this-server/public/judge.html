<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Picture This - Judge Interface</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .judge-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 1200px;
      width: 100%;
      padding: 40px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5em;
      color: #333;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1em;
      color: #666;
      margin-bottom: 5px;
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px 0;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status-message {
      text-align: center;
      color: #666;
      font-size: 1em;
      margin: 20px 0;
    }

    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .image-card {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 3px solid transparent;
    }

    .image-wrapper {
      position: relative;
      width: 100%;
      padding-bottom: 100%; /* 1:1 aspect ratio */
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-wrapper img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      color: #999;
    }

    .player-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      font-weight: bold;
      text-align: center;
    }

    .image-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    /* Selection state styles */
    .image-card.selected-1st {
      border-color: #ffc107;
      box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
    }

    .image-card.selected-2nd {
      border-color: #c0c0c0;
      box-shadow: 0 0 20px rgba(192, 192, 192, 0.6);
    }

    .selection-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: bold;
      color: white;
      font-size: 2em;
      z-index: 10;
    }

    .selection-badge.first {
      background: #ffc107;
    }

    .selection-badge.second {
      background: #c0c0c0;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      min-width: 120px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95em;
      transition: all 0.3s ease;
    }

    .btn-1st {
      background: #ffc107;
      color: #333;
    }

    .btn-1st:hover:not(:disabled) {
      background: #ffb300;
      transform: scale(1.05);
    }

    .btn-2nd {
      background: #c0c0c0;
      color: #333;
    }

    .btn-2nd:hover:not(:disabled) {
      background: #a0a0a0;
      transform: scale(1.05);
    }

    .btn-deselect {
      background: #f44336;
      color: white;
    }

    .btn-deselect:hover:not(:disabled) {
      background: #d32f2f;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .selections-summary {
      background: #f5f5f5;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
    }

    .selections-summary h3 {
      margin-bottom: 20px;
      color: #333;
      font-size: 1.2em;
    }

    .selection-item {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .selection-item:last-child {
      margin-bottom: 0;
    }

    .selection-label {
      font-weight: 600;
      min-width: 120px;
    }

    .selection-label.first {
      color: #ffc107;
    }

    .selection-label.second {
      color: #c0c0c0;
    }

    .selection-info {
      flex: 1;
      color: #666;
    }

    .submit-button {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 1.1em;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .submit-button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .submit-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #c62828;
    }

    .success-message {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #2e7d32;
    }

    .instruction {
      background: #e3f2fd;
      color: #1565c0;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #1565c0;
    }

    @media (max-width: 768px) {
      .judge-container {
        padding: 20px;
      }

      .header h1 {
        font-size: 1.8em;
      }

      .images-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }

      button {
        padding: 10px 15px;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <div class="judge-container">
    <div class="header">
      <h1>ðŸŽ¬ Judge Selection</h1>
      <p id="gameCodeDisplay">Game Code: <span id="gameCode">-</span></p>
      <p id="sentenceDisplay">Sentence: <span id="sentence">-</span></p>
    </div>

    <div id="loadingState">
      <div style="text-align: center;">
        <div class="loading-spinner"></div>
        <p class="status-message">Loading images...</p>
        <p class="status-message" style="font-size: 0.9em; color: #999;">
          Waiting for all players to submit images
        </p>
      </div>
    </div>

    <div id="judgeInterface" style="display: none;">
      <div class="instruction">
        ðŸ“¸ <strong>Review the images and select:</strong>
        <ul style="margin-top: 8px; margin-left: 20px;">
          <li>ðŸ¥‡ <strong>1st Place:</strong> The funniest/best image</li>
          <li>ðŸ¥ˆ <strong>2nd Place:</strong> Your second favorite</li>
        </ul>
      </div>

      <div id="errorMessage" class="error-message" style="display: none;"></div>
      <div id="successMessage" class="success-message" style="display: none;"></div>

      <div class="images-grid" id="imagesGrid"></div>

      <div class="selections-summary">
        <h3>Your Selections</h3>
        <div class="selection-item">
          <div class="selection-label first">ðŸ¥‡ 1st Place:</div>
          <div class="selection-info" id="firstPlaceInfo">Not selected</div>
        </div>
        <div class="selection-item">
          <div class="selection-label second">ðŸ¥ˆ 2nd Place:</div>
          <div class="selection-info" id="secondPlaceInfo">Not selected</div>
        </div>
      </div>

      <button class="submit-button" id="submitButton" disabled>
        Submit Selections
      </button>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    // Judge Interface Client Script
    const gameCode = new URLSearchParams(window.location.search).get('code');
    const judgeId = new URLSearchParams(window.location.search).get('judgeId');
    
    let judgeState = {
      images: [],
      firstPlace: null,
      secondPlace: null,
      submitted: false
    };

    let socket = null;

    function initializeWebSocket() {
      socket = io();
      
      socket.on('connected', (data) => {
        console.log('Connected to WebSocket:', data.socket_id);
        // Emit judge ready event
        socket.emit('judge-ready', {
          judgeId: judgeId,
          code: gameCode
        });
      });

      socket.on('error', (data) => {
        console.error('WebSocket error:', data);
        showError('Connection error: ' + data.message);
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from WebSocket');
        showError('Lost connection to server. Refreshing...');
        setTimeout(() => window.location.reload(), 3000);
      });
    }

    async function initializeJudge() {
      try {
        // Initialize WebSocket first
        initializeWebSocket();

        // Fetch images
        const imagesRes = await fetch(`/api/judge/${gameCode}/images`);
        if (!imagesRes.ok) {
          throw new Error('Failed to fetch images');
        }

        const data = await imagesRes.json();
        judgeState.images = data.images;
        judgeState.totalImages = data.totalImages;

        document.getElementById('gameCode').textContent = gameCode.toUpperCase();
        document.getElementById('sentence').textContent = data.sentenceTemplate || 'Loading...';

        // Wait for all images to load
        await loadAllImages(data.images);

        // Show judge interface
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('judgeInterface').style.display = 'block';

        // Render image cards
        renderImages();

        // Load any existing selections
        await loadExistingSelections();
      } catch (error) {
        showError('Failed to initialize judge interface: ' + error.message);
      }
    }

    async function loadAllImages(images) {
      const promises = images.map(img => {
        return new Promise((resolve) => {
          if (!img.imageUrl) {
            resolve();
            return;
          }

          const testImg = new Image();
          testImg.onload = resolve;
          testImg.onerror = resolve;
          testImg.src = img.imageUrl;

          // Timeout after 10 seconds
          setTimeout(resolve, 10000);
        });
      });

      await Promise.all(promises);
    }

    function renderImages() {
      const grid = document.getElementById('imagesGrid');
      grid.innerHTML = '';

      judgeState.images.forEach(image => {
        const card = document.createElement('div');
        card.className = 'image-card';
        card.id = `image-${image.playerId}`;

        let selectionClass = '';
        let badge = '';
        if (judgeState.firstPlace === image.playerId) {
          selectionClass = 'selected-1st';
          badge = '<div class="selection-badge first">ðŸ¥‡</div>';
        } else if (judgeState.secondPlace === image.playerId) {
          selectionClass = 'selected-2nd';
          badge = '<div class="selection-badge second">ðŸ¥ˆ</div>';
        }

        card.className += ' ' + selectionClass;

        card.innerHTML = `
          ${badge}
          <div class="image-wrapper">
            ${image.imageUrl ? `<img src="${image.imageUrl}" alt="Player ${image.playerNumber}">` : ''}
            ${!image.imageUrl ? '<div class="image-loading">ðŸ“·<br>Loading...</div>' : ''}
          </div>
          <div class="player-label">Player ${image.playerNumber}</div>
          <div class="button-group">
            <button class="btn-1st" onclick="selectFirst('${image.playerId}')">ðŸ¥‡ 1st</button>
            <button class="btn-2nd" onclick="selectSecond('${image.playerId}')">ðŸ¥ˆ 2nd</button>
          </div>
        `;

        grid.appendChild(card);
      });
    }

    async function selectFirst(playerId) {
      judgeState.firstPlace = playerId;
      updateDisplay();
      updateSubmitButton();
    }

    async function selectSecond(playerId) {
      judgeState.secondPlace = playerId;
      updateDisplay();
      updateSubmitButton();
    }

    function updateDisplay() {
      // Update summary display
      if (judgeState.firstPlace) {
        const img = judgeState.images.find(i => i.playerId === judgeState.firstPlace);
        document.getElementById('firstPlaceInfo').textContent = `Player ${img.playerNumber} âœ“`;
      } else {
        document.getElementById('firstPlaceInfo').textContent = 'Not selected';
      }

      if (judgeState.secondPlace) {
        const img = judgeState.images.find(i => i.playerId === judgeState.secondPlace);
        document.getElementById('secondPlaceInfo').textContent = `Player ${img.playerNumber} âœ“`;
      } else {
        document.getElementById('secondPlaceInfo').textContent = 'Not selected';
      }

      // Update visual badges
      judgeState.images.forEach(image => {
        const card = document.getElementById(`image-${image.playerId}`);
        card.classList.remove('selected-1st', 'selected-2nd');

        if (judgeState.firstPlace === image.playerId) {
          card.classList.add('selected-1st');
        } else if (judgeState.secondPlace === image.playerId) {
          card.classList.add('selected-2nd');
        }
      });
    }

    function updateSubmitButton() {
      const btn = document.getElementById('submitButton');
      btn.disabled = !judgeState.firstPlace || !judgeState.secondPlace;
    }

    async function loadExistingSelections() {
      try {
        const res = await fetch(`/api/judge/${gameCode}/selections`);
        if (res.ok) {
          const data = await res.json();
          if (data.firstPlaceId) judgeState.firstPlace = data.firstPlaceId;
          if (data.secondPlaceId) judgeState.secondPlace = data.secondPlaceId;
          updateDisplay();
          updateSubmitButton();
        }
      } catch (error) {
        console.log('No existing selections');
      }
    }

    async function submitSelections() {
      try {
        const res = await fetch(`/api/judge/${gameCode}/submit-selection`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            firstPlaceId: judgeState.firstPlace,
            secondPlaceId: judgeState.secondPlace
          })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Submission failed');
        }

        const submitData = await res.json();
        judgeState.submitted = true;
        document.getElementById('submitButton').disabled = true;
        
        // Emit WebSocket event for real-time broadcast
        if (socket && socket.connected) {
          socket.emit('judge-submission', {
            code: gameCode,
            judgeId: judgeId,
            firstPlaceId: judgeState.firstPlace,
            secondPlaceId: judgeState.secondPlace
          });
        }
        
        showSuccess('Selections submitted! The results will be shown shortly.');
      } catch (error) {
        showError('Failed to submit: ' + error.message);
      }
    }

    function showError(message) {
      const el = document.getElementById('errorMessage');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function showSuccess(message) {
      const el = document.getElementById('successMessage');
      el.textContent = message;
      el.style.display = 'block';
    }

    document.getElementById('submitButton').addEventListener('click', submitSelections);

    // Initialize when page loads
    window.addEventListener('load', initializeJudge);
  </script>
</body>
</html>
